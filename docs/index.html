<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SFCompute Pricing</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b0c10;--card:#151720;--muted:#9aa0aa;--text:#e8eaed;--accent:#6aa9ff}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2);margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
    select{background:#0e1117;border:1px solid #2a2f3a;color:var(--text);border-radius:10px;padding:8px 10px}
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid #2a2f3a;margin-top:12px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:560px}
    th,td{padding:8px 10px;border-bottom:1px solid #242a34}
    th{position:sticky;top:0;background:#10131a;color:#cfd3da;font-weight:600}
    tr:hover td{background:#121722}
    .mono{font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:12px;margin-top:8px}
    .kpi div{background:#10131a;border:1px solid #222a35;border-radius:12px;padding:10px}
    .kpi strong{font-size:16px}

    /* compact chart height */
    .chart-wrap{position:relative;height:250px;width:100%;}
    @media (max-width: 900px){ .chart-wrap{ height:220px; } }
    @media (max-width: 520px){ .chart-wrap{ height:200px; } }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>SFCompute Pricing</h1>
    <div class="muted">Data: <code>data/sfcompute_latest.csv</code> & <code>data/sfcompute_history.csv</code></div>
  </header>

  <!-- LATEST (single most recent snapshot only) -->
  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <div>
        <label for="gpu">GPU</label>
        <select id="gpu"></select>
      </div>
      <div>
        <label for="duration">Duration</label>
        <select id="duration"></select>
      </div>
      <div>
        <label for="count">GPU Count</label>
        <select id="count"></select>
      </div>
      <div style="margin-left:auto">
        <span class="muted" id="lastRefresh">loading…</span>
      </div>
    </div>

    <div class="kpi">
      <div><span class="muted">Latest snapshot (UTC)</span><br><strong id="kpiDate">—</strong></div>
      <div><span class="muted">Selected price</span><br><strong class="mono" id="kpiPrice">—</strong></div>
      <div><span class="muted">Min across counts</span><br><strong class="mono" id="kpiMin">—</strong></div>
      <div><span class="muted">Max across counts</span><br><strong class="mono" id="kpiMax">—</strong></div>
    </div>

    <div class="table-wrap">
      <table id="latestTable"></table>
    </div>
  </div>

    <!-- HISTORY (filterable) -->
  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <div>
        <label for="day">Day (history)</label>
        <select id="day"></select>
      </div>
      <div style="margin-left:auto">
        <label><input type="checkbox" id="showForecast"> Show forecast</label>
      </div>
    </div>
    <div class="chart-wrap">
      <canvas id="histChart"></canvas>
    </div>
    <div id="modelBadge" class="muted" style="margin-top:6px;font-size:12px">—</div>
  </div>

  <!-- ALERTS -->
  <div class="card">
    <h3 style="margin-top:0;font-size:16px">Price Alerts</h3>
    <div id="alertsBox" class="muted">Loading…</div>
  </div>

  <!-- ROI CALCULATOR -->
  <div class="card">
    <h3 style="margin-top:0;font-size:16px">ROI / Budget Calculator</h3>
    <div class="table-wrap">
      <table id="roiTable"></table>
    </div>
  </div>
</div> <!-- end wrap -->

<script>
  // === new paths ===
  const FORECAST_PATH = 'data/sfcompute_forecast.csv?ts=' + Date.now();
  const METRICS_PATH  = 'data/sfcompute_metrics.csv?ts=' + Date.now();
  const ALERTS_PATH   = 'data/alerts.csv?ts=' + Date.now();
  const ROI_PATH      = 'data/roi_catalog.csv?ts=' + Date.now();

  let FORECAST = [], METRICS = [], ALERTS = [], ROI = [];

  async function loadExtras(){
    try{
      [FORECAST, METRICS, ALERTS, ROI] = await Promise.all([
        csv(FORECAST_PATH), csv(METRICS_PATH), csv(ALERTS_PATH), csv(ROI_PATH)
      ]);

      // Alerts
      const box = document.getElementById('alertsBox');
      if (!ALERTS.length){
        box.textContent = "✅ No active alerts";
      } else {
        box.innerHTML = ALERTS.map(r =>
          `⚠️ ${r.gpu_type} · ${r.duration} · ${r.gpu_count} → $${Number(r.usd_per_gpu_hr).toFixed(2)} (vs ${Number(r.benchmark_price).toFixed(2)})`
        ).join('<br>');
      }

      // ROI table
      if (ROI.length){
        const tbl = document.getElementById('roiTable');
        let html = '<thead><tr><th>GPU</th><th>Duration</th><th>Count</th><th>Utilisation</th><th>Monthly Cost</th></tr></thead><tbody>';
        for(const r of ROI){
          html += `<tr>
            <td>${r.gpu_type}</td>
            <td>${r.duration}</td>
            <td>${r.gpu_count}</td>
            <td>${(r.utilisation*100).toFixed(0)}%</td>
            <td class="mono">$${Number(r.monthly_cost_usd).toFixed(0)}</td>
          </tr>`;
        }
        html += '</tbody>';
        tbl.innerHTML = html;
      }
    }catch(e){ console.warn("extras failed",e); }
  }

  // --- modify renderHistory to add forecast overlay + badge ---
  const oldRenderHistory = renderHistory;
  renderHistory = function(gpuSel,durationSel,countSel){
    oldRenderHistory(gpuSel,durationSel,countSel);

    if(!document.getElementById('showForecast').checked || !FORECAST.length) return;

    const rows = FORECAST.filter(r =>
      r.gpu_type===gpuSel && r.duration===durationSel && Number(r.gpu_count)===Number(countSel)
    ).sort((a,b)=> String(a.ds||a.ts_utc).localeCompare(String(b.ds||b.ts_utc)));

    if(!rows.length) return;
    const labels = rows.map(r=> r.ds || r.ts_utc);
    const yhat   = rows.map(r=> Number(r.yhat));
    const lower  = rows.map(r=> Number(r.yhat_lower));
    const upper  = rows.map(r=> Number(r.yhat_upper));

    // add forecast line + band to existing chart
    chart.data.datasets.push({
      label: "Forecast",
      data: yhat, borderColor:"#6aa9ff", borderDash:[5,4], fill:false, tension:.2
    });
    chart.data.datasets.push({
      label: "Forecast CI",
      data: yhat, borderColor:"transparent",
      backgroundColor:"rgba(106,169,255,0.15)", fill:true,
      tension:.2, pointRadius:0
    });
    chart.update();

    // badge (use metrics if available)
    const m = METRICS.find(r=> r.gpu_type===gpuSel && r.duration===durationSel && Number(r.gpu_count)===Number(countSel));
    if(m){
      const skill = (Number(m.skill)*100).toFixed(1);
      const smape = Number(m.smape).toFixed(1);
      document.getElementById('modelBadge').textContent =
        `Model skill vs naive: ${skill}% · SMAPE: ${smape}%`;
    }
  };

  document.getElementById('showForecast').onchange = updateAll;

  // --- run extras loader after main() finishes ---
  main().then(loadExtras);
</script>
</body>
</html>
